% !TEX program = lualatex
\documentclass[aspectratio=169,professionalfonts]{beamer}
\input{../preamble.tex}
\usepackage{mwe}

\title[ClústerLab • Día 3]{Diagnóstico en tiempo real y reto grupal}
\subtitle{Monitoreo, registros y uso de \texttt{sshfs}}
\author{Equipo docente ClústerLab}
\date{8 de agosto de 2025}

\begin{document}

%------------------------------ portada ----------------------------
\begin{frame}[plain]
  \titlepage
\end{frame}

%------------------------------ sshfs persistente ------------------
\begin{frame}[fragile]{Montaje permanente con \texttt{sshfs}}
  \begin{minted}{bash}
$ echo 'pi@head:/home/shared /home/cluster/shared fuse.sshfs defaults,_netdev 0 0' | sudo tee -a /etc/fstab
  \end{minted}
  Requiere claves SSH configuradas y el paquete \texttt{sshfs} instalado en el arranque.
\end{frame}

%------------------------------ log example -----------------------
\begin{frame}[fragile]{Ejemplo de registro}
  \begin{center}
    \includegraphics[width=.7\textwidth]{example-image}
  \end{center}
  Salida típica al ejecutar \texttt{tail -f /var/log/health.log}.
\end{frame}

%------------------------------ logs -------------------------------
\begin{frame}[fragile]{Revisión de logs con \texttt{journalctl}}
  \begin{minted}{bash}
$ sudo journalctl -u ssh
$ sudo journalctl -f
  \end{minted}
  \begin{itemize}
    \item Usa \texttt{-u} o \texttt{-b} para filtrar servicios o arranques.
    \item Con \texttt{-f} observas mensajes en tiempo real.
  \end{itemize}
\end{frame}

%------------------------------ objetivos --------------------------
\begin{frame}[fragile]{Objetivos de la sesión}
  \begin{itemize}
    \item Utilizar herramientas de monitoreo (\texttt{htop}, \texttt{df}, \texttt{iotop}, \texttt{watch}).
    \item Crear un script de salud que registre el estado del sistema cada minuto.
    \item Montar un directorio remoto mediante \texttt{sshfs}.
    \item Acceder a nodos por nombre de host usando mDNS/Avahi.
  \end{itemize}
\end{frame}

%------------------------------ agenda -----------------------------
\begin{frame}[fragile]{Agenda (10:45 – 13:00)}
  \begin{enumerate}
    \item Monitorizar CPU, memoria, disco y sensores en tiempo real.
    \item Desarrollar y ejecutar \texttt{healthcheck.sh}.
    \item Instalar \texttt{sshfs} y montar \texttt{/home/shared}.
    \item Configurar resolución de nombres vía Avahi (mDNS).
  \end{enumerate}
\end{frame}

%------------------------------ monitoreo --------------------------
\begin{frame}[fragile]{Herramientas de diagnóstico}
  \begin{minted}{bash}
$ htop          # procesos y CPU en tiempo real
$ df -h         # uso de disco legible
$ iotop         # I/O por proceso (necesita root)
$ watch -n1 sensors # temperatura y voltajes cada segundo
  \end{minted}
  \begin{infobox}
  Ajusta el intervalo de \texttt{watch} según tus necesidades (\texttt{-n2} para cada 2 s, etc.). \texttt{iotop} requiere privilegios y puede instalarse vía \texttt{sudo apt install iotop}.
  \end{infobox}
\end{frame}

%------------------------------ script salud -----------------------
\begin{frame}[fragile]{Script \texttt{healthcheck.sh}}
  \begin{minted}{bash}
#!/usr/bin/env bash
LOG=/var/log/health.log
while true; do
  timestamp=$(date "+%F %T")
  load=$(uptime | awk -F'load average: ' '{print $2}')
  temp=$(vcgencmd measure_temp | cut -d= -f2)
  echo "$timestamp | load: $load | temp: $temp" >> "$LOG"
  sleep 60
done
  \end{minted}
  \begin{warnbox}
  Asegúrate de que \texttt{healthcheck.sh} tenga permisos de ejecución (\texttt{chmod +x healthcheck.sh}). Revisa el log periódicamente con \texttt{tail -f}.
  \end{warnbox}
\end{frame}

%------------------------------ sshfs -------------------------------
\begin{frame}[fragile]{Compartir directorios con \texttt{sshfs}}
  \begin{minted}{bash}
$ sudo apt install -y sshfs
$ mkdir -p ~/shared
$ sshfs pi@head:/home/shared ~/shared
# Trabaja como si fuera local...
$ fusermount -u ~/shared  # para desmontar
  \end{minted}
  \begin{infobox}
  \texttt{sshfs} utiliza el mismo mecanismo de autenticación que \texttt{ssh}. Asegúrate de tener configurado tu par de claves y permisos adecuados en el directorio remoto.
  \end{infobox}
\end{frame}

%------------------------------ nombres host -----------------------
\begin{frame}[fragile]{Acceso por nombre de host}
  Instala y habilita Avahi para resolución mDNS:
  \begin{minted}{bash}
$ sudo apt install -y avahi-daemon libnss-mdns
$ sudo systemctl enable --now avahi-daemon
  \end{minted}
  \begin{itemize}
    \item Con mDNS activo, puedes conectarte usando \texttt{ssh pi@node03.local} en lugar de la IP.
    \item Asegúrate de que todos los nodos tengan nombres únicos y Avahi habilitado.
  \end{itemize}
\end{frame}

%------------------------------ actividad --------------------------
\begin{frame}[fragile]{Actividad práctica}
  \begin{enumerate}
    \item Ejecuta las herramientas de monitoreo y comparte capturas de tu Pi bajo carga.
    \item Lanza \texttt{healthcheck.sh} y revisa el log después de unos minutos.
    \item Consulta los últimos eventos con \texttt{journalctl -u ssh}.
    \item Monta el directorio compartido con \texttt{sshfs} y crea un archivo de prueba.
    \item Conéctate a otro nodo usando su nombre (\texttt{ssh pi@node02.local}) y verifica la presencia del archivo.
  \end{enumerate}
\end{frame}

%------------------------------ resumen ----------------------------
\begin{frame}[fragile]{Resumen}
  \begin{itemize}
    \item Practicaste el uso de herramientas de diagnóstico en tiempo real.
    \item Automatizaste la recolección de métricas con un script de salud.
    \item Compartiste directorios mediante \texttt{sshfs} y configuraste nombres de host.
  \end{itemize}
  \vspace{0.5em}
  Con esto tu clúster está listo para tareas de cómputo distribuido.
\end{frame}

\end{document}